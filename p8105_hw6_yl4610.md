p8105_hw6_yl4610
================
Yuxin Liu
2022-11-21

``` r
library(tidyverse)
```

# Question 2

``` r
homicide_raw = 
  read_csv( "./data/homicide_data.csv") %>% 
    mutate (
    city_state = str_c(city, ", ", state),
    result = ifelse(disposition != "Closed by arrest", "unsolved", "solved")) %>% 
    filter(!(city_state %in% c("Tulsa, AL", "Dallas, TX", "Phoenix, AZ", "Kansas City, MO"))) %>% 
    filter(victim_race %in% c("White", "Black")) %>% 
    filter(!(victim_age %in% c("Unknown"))) %>% 
    mutate (victim_age = as.numeric(victim_age))

homicide_raw 
```

    ## # A tibble: 39,403 × 14
    ##    uid   repor…¹ victi…² victi…³ victi…⁴ victi…⁵ victi…⁶ city  state   lat   lon
    ##    <chr>   <dbl> <chr>   <chr>   <chr>     <dbl> <chr>   <chr> <chr> <dbl> <dbl>
    ##  1 Alb-…  2.01e7 SATTER… VIVIANA White        15 Female  Albu… NM     35.1 -107.
    ##  2 Alb-…  2.01e7 MULA    VIVIAN  White        72 Female  Albu… NM     35.1 -107.
    ##  3 Alb-…  2.01e7 BOOK    GERALD… White        91 Female  Albu… NM     35.2 -107.
    ##  4 Alb-…  2.01e7 MARTIN… GUSTAVO White        56 Male    Albu… NM     35.1 -107.
    ##  5 Alb-…  2.01e7 GRAY    STEFAN… White        43 Female  Albu… NM     35.1 -107.
    ##  6 Alb-…  2.01e7 DAVID   LARRY   White        52 Male    Albu… NM     NA     NA 
    ##  7 Alb-…  2.01e7 BRITO   ELIZAB… White        22 Female  Albu… NM     35.1 -107.
    ##  8 Alb-…  2.01e7 KING    TEVION  Black        15 Male    Albu… NM     35.1 -107.
    ##  9 Alb-…  2.01e7 BOYKIN  CEDRIC  Black        25 Male    Albu… NM     35.1 -107.
    ## 10 Alb-…  2.01e7 BARRAG… MIGUEL  White        20 Male    Albu… NM     35.1 -107.
    ## # … with 39,393 more rows, 3 more variables: disposition <chr>,
    ## #   city_state <chr>, result <chr>, and abbreviated variable names
    ## #   ¹​reported_date, ²​victim_last, ³​victim_first, ⁴​victim_race, ⁵​victim_age,
    ## #   ⁶​victim_sex

I used mutate to create a city_state variable and a binary variable
indicating whether the homicide is solved. I used filter to omit cities
Dallas, TX; Phoenix, AZ; and Kansas City, MO; Tulsa, AL. Also, I used
filter to limit victim_race as White or Black and delete unknown age.
Lastly, I used mutate to change victim_age to numeric format.

``` r
Baltimore_reg = 
 homicide_raw %>% 
  filter(city_state == "Baltimore, MD") %>%
  mutate (y_var = ifelse(result == "solved",0,1)) %>% 
    glm(y_var ~ victim_age + victim_sex + victim_race, data =., family = 'binomial'(link='logit')) %>% 
    broom::tidy () %>% 
    mutate(odds_ratio = exp(estimate),
           lower_bound = exp(estimate - 1.96 * std.error),
           upper_bound = exp(estimate + 1.96 * std.error)) %>% 
    select(term, estimate, odds_ratio, lower_bound,upper_bound ) %>% 
    filter(term == "victim_sexMale") %>% 
    knitr::kable(digits = 4)
Baltimore_reg
```

| term           | estimate | odds_ratio | lower_bound | upper_bound |
|:---------------|---------:|-----------:|------------:|------------:|
| victim_sexMale |   0.8545 |     2.3501 |      1.7925 |      3.0811 |

For the city of Baltimore, MD, I used the glm function to fit a logistic
regression with resolved vs unresolved as the outcome and victim age,
sex and race as predictors. Save the output of glm as an R object; apply
the broom::tidy to this object; and obtain the estimate and confidence
interval of the adjusted odds ratio for solving homicides comparing male
victims to female victims keeping all other variables fixed.

``` r
homicide_all_cities = 
  homicide_raw %>% 
  mutate (y_var = ifelse(result == "solved",0,1)) %>%
  nest(data = -city_state) %>% 
  mutate(
    glm_all_cities = map(data, ~glm(y_var ~ victim_age + victim_sex + victim_race, data = ., family = 'binomial'(link='logit'))),
    results = map(glm_all_cities, broom::tidy)) 
homicide_all_cities
```

    ## # A tibble: 47 × 4
    ##    city_state      data                  glm_all_cities results         
    ##    <chr>           <list>                <list>         <list>          
    ##  1 Albuquerque, NM <tibble [174 × 14]>   <glm>          <tibble [5 × 5]>
    ##  2 Atlanta, GA     <tibble [940 × 14]>   <glm>          <tibble [4 × 5]>
    ##  3 Baltimore, MD   <tibble [2,753 × 14]> <glm>          <tibble [4 × 5]>
    ##  4 Baton Rouge, LA <tibble [409 × 14]>   <glm>          <tibble [4 × 5]>
    ##  5 Birmingham, AL  <tibble [763 × 14]>   <glm>          <tibble [4 × 5]>
    ##  6 Boston, MA      <tibble [492 × 14]>   <glm>          <tibble [5 × 5]>
    ##  7 Buffalo, NY     <tibble [472 × 14]>   <glm>          <tibble [4 × 5]>
    ##  8 Charlotte, NC   <tibble [571 × 14]>   <glm>          <tibble [4 × 5]>
    ##  9 Chicago, IL     <tibble [4,502 × 14]> <glm>          <tibble [4 × 5]>
    ## 10 Cincinnati, OH  <tibble [678 × 14]>   <glm>          <tibble [4 × 5]>
    ## # … with 37 more rows

I run glm for each of the cities, and extract the adjusted odds ratio
(and CI) for solving homicides comparing male victims to female victims.
Do this within a “tidy” pipeline, making use of purrr::map, list
columns, and unnest as necessary to create a dataframe with estimated
ORs and CIs for each city.
